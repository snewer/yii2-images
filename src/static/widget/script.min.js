!function(a){function e(a){return a.size>0&&/^image/.test(a.type)}a.fn.ImageUploadWidget=function(t){var i,o=this.first(),n=!1,d=a('<div class="image-upload-widget-modal modal inmodal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content animated bounceInRight"><div class="modal-footer" style="border-top: none"><h5 class="pull-left">Загрузка изображения</h5><button type="button" class="image-upload-widget-modal-rotate-right-btn btn btn-primary"><span class="fa fa-rotate-right"></span></button><button type="button" class="image-upload-widget-modal-rotate-left-btn btn btn-primary"><span class="fa fa-rotate-left"></span></button></div><table style="width: 100%"><tbody><tr style="vertical-align: top"><td><div class="cropper-wrapper"><img src="#" style="display: none"></div></td></tr></tbody></table><div class="modal-footer" style="border-top: none"><button type="button" class="btn btn-white" data-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary ladda-button image-upload-widget-modal-upload-btn" data-style="expand-right">Зарузить выбранное</button></div></div></div></div>'),l=d.find(".image-upload-widget-modal-upload-btn").first(),s=d.find(".cropper-wrapper img").first(),r=d.find(".image-upload-widget-modal-rotate-left-btn"),c=d.find(".image-upload-widget-modal-rotate-right-btn"),p=a('<div class="image-upload-widget"><div class="uploaded-image-container-wrapper"><div class="uploaded-image-container"><div class="uploaded-image-preview"><img src="'+t.emptyImage+'"></div><div class="uploaded-image-toolbar"><span style="visibility: hidden" title="Обрезать изображение" class="edit fa fa-crop"></span><span  style="visibility: hidden" title="Удалить изображение" class="remove fa fa-times"></span><div class="clearfix"></div></div></div></div><div class="image-upload-tools"><span class="image-upload-tools-clickable select-image-from-device">Выбрать файл с компьютера</span> <span class="image-upload-tools-clickable select-image-from-url">или по URL</span></div></div>'),u=p.find(".uploaded-image-container-wrapper");function m(){d.modal("hide")}function f(){d.find("input, button, textarea").prop("disabled",!1),s.cropper("enable"),!1}function g(e){var t=a.Deferred(),o=new FileReader;return o.onload=function(a){i={src:a.target.result},t.resolve()},o.readAsDataURL(e),t.promise()}function v(e){return a.post(t.urls.imageProxy,{url:e},function(a){a.success&&(i={src:a.base64},b())},"json")}function b(){d.modal("show"),n?s.cropper("replace",i.src):(s.attr("src",i.src),s.cropper({autoCropArea:1,aspectRatio:t.aspectRatio>0?t.aspectRatio:NaN,checkCrossOrigin:!1,guides:!1,checkOrientation:!1,crop:function(){i.crop=a(this).cropper("getData",!0)}}),n=!0)}function y(e){var i=a('<div class="uploaded-image-container"><div class="uploaded-image-preview"><a href="'+e.image.url+'" target="_blank" style="display: block"><img src="'+e.preview.url+'"></a></div><div class="uploaded-image-toolbar"><span title="Обрезать изображение" class="edit fa fa-crop"></span><span title="Удалить изображение" class="remove fa fa-times"></span><div class="clearfix"></div></div></div>');u.html(i),i.find("a").magnificPopup({type:"image",closeOnContentClick:!0,mainClass:"mfp-img-mobile",image:{verticalFit:!0}}),i.find(".remove").on("click",function(){if(confirm("Удалить?")){o.val("");var a='<div class="uploaded-image-container-wrapper"><div class="uploaded-image-container"><div class="uploaded-image-preview"><img src="'+t.emptyImage+'"></div></div></div>';u.html(a)}}),i.find(".edit").on("click",function(){v(e.image.url)})}o.after(p),o.after(d),c.on("click",function(){s.cropper("rotate",45)}),r.on("click",function(){s.cropper("rotate",-45)}),l.ladda(),d.modal({backdrop:"static",keyboard:!1,show:!1}),l.on("click",function(){var e,n=a(this);d.find("input, button, textarea").prop("disabled",!0),s.cropper("disable"),!0,n.ladda("start"),n.find(".ladda-label").text("Идет загрузка..."),(e=a.Deferred(),a.post(t.urls.imageUpload,{source:i.src,options:{aspectRatio:t.aspectRatio,supportAC:t.supportAC,bgColor:t.bgColor,crop:i.crop||{}}}).done(function(a){i.src="",!0===a.success?(y(a),o.val(a.image.id),e.resolve(a)):e.reject()}),e.promise()).done(function(){f(),n.find(".ladda-label").text("Загрузить"),n.ladda("stop"),m()}).fail(function(){alert("Загрузить изображение не удалось"),f(),n.find(".ladda-label").text("Загрузить"),n.ladda("stop"),m()})}),p.find(".select-image-from-device").on("click",function(){var t=a('<input type="file" style="display:none">');a("body").append(t),t.on("change",function(){var a=this.files[0];e(a)&&g(a).done(function(){b()}),t.remove()}),t.click()}),p.find(".select-image-from-url").on("click",function(){var a=prompt("Введите ссылку на изображение","http://");a&&v(a)}),p[0].ondragover=function(){return!1},p[0].ondragleave=function(){return!1},p[0].ondrop=function(a){var t=a.dataTransfer.files[0];e(t)&&g(t).done(function(){b()}),a.preventDefault()},o.val()>0&&a.post(t.urls.getImage,{id:o.val()},function(a){!0===a.success&&y(a)},"json")}}(jQuery);