!function(t){function a(t){return t.size>0&&/^image/.test(t.type)}t.fn.ImagesWidget=function(e){var i,o=this.first(),n=!1,r=t('<div class="image-upload-widget-modal modal inmodal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content animated bounceInRight"><div class="modal-footer" style="border-top: none"><h5 class="pull-left">Загрузка изображения</h5><button type="button" class="image-upload-widget-modal-rotate-right-btn btn btn-primary"><span class="fa fa-rotate-right"></span></button><button type="button" class="image-upload-widget-modal-rotate-left-btn btn btn-primary"><span class="fa fa-rotate-left"></span></button></div><table style="width: 100%"><tbody><tr style="vertical-align: top"><td><div class="cropper-wrapper"><img src="#" style="display: none"></div></td></tr></tbody></table><div class="modal-footer" style="border-top: none"><button type="button" class="btn btn-white" data-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary ladda-button image-upload-widget-modal-upload-btn" data-style="expand-right">Зарузить выбранное</button></div></div></div></div>'),d=r.find(".image-upload-widget-modal-upload-btn").first(),l=r.find(".cropper-wrapper img").first(),s=r.find(".image-upload-widget-modal-rotate-left-btn"),c=r.find(".image-upload-widget-modal-rotate-right-btn"),p=t('<div class="image-upload-widget"><div class="uploaded-image-container-wrapper"><div class="uploaded-image-container"><div class="uploaded-image-preview"><img src="'+e.emptyImage+'"></div></div></div><div class="image-upload-tools"><span class="image-upload-tools-clickable select-image-from-device">Выбрать файл с компьютера</span> <span class="image-upload-tools-clickable select-image-from-url">или по URL</span></div></div>'),u=p.find(".uploaded-image-container-wrapper");function m(a){var e=t.Deferred(),o=new FileReader;return o.onload=function(t){i={src:t.target.result},e.resolve()},o.readAsDataURL(a),e.promise()}function f(a){return t.post(e.urls.imageProxy,{url:a},function(t){t.success&&(i={src:t.base64},g())},"json")}function g(){r.modal("show"),n?l.cropper("replace",i.src):(l.attr("src",i.src),l.cropper({autoCropArea:1,aspectRatio:e.aspectRatio>0?e.aspectRatio:NaN,checkCrossOrigin:!1,guides:!1,checkOrientation:!1,crop:function(){i.crop=t(this).cropper("getData",!0)}}),n=!0)}function v(a){var e=t('<div class="uploaded-image-container"><div class="uploaded-image-preview"><a href="'+a.image.url+'" target="_blank" style="display: block"><img src="'+a.preview.url+'"></a></div><div class="uploaded-image-toolbar"><span title="Обрезать изображение" class="edit fa fa-crop"></span><span title="Удалить изображение" class="remove fa fa-times"></span><div class="clearfix"></div></div></div>');u.html(e),e.find("a").magnificPopup({type:"image",closeOnContentClick:!0,mainClass:"mfp-img-mobile",image:{verticalFit:!0}}),e.find(".remove").on("click",function(){confirm("Удалить?")&&(o.val(""),e.remove())}),e.find(".edit").on("click",function(){f(a.image.url)})}o.after(p),o.after(r),c.on("click",function(){l.cropper("rotate",45)}),s.on("click",function(){l.cropper("rotate",-45)}),d.ladda(),r.modal({backdrop:"static",keyboard:!1,show:!1}),d.on("click",function(){var a,n=t(this);r.find("input, button, textarea").prop("disabled",!0),l.cropper("disable"),!0,n.ladda("start"),n.find(".ladda-label").text("Идет загрузка..."),(a=t.Deferred(),t.post(e.urls.imageUpload,{source:i.src,options:{trim:e.trim,aspectRatio:e.aspectRatio,minWidth:e.minWidth,minHeight:e.minHeight,maxWidth:e.maxWidth,maxHeight:e.maxHeight,supportAC:e.supportAC,bgColor:e.bgColor,crop:i.crop||{}}}).done(function(t){i.uploaded=!0,i.src="",!0===t.success?(v(t),o.val(t.image.id),a.resolve(t)):a.reject()}).fail(function(){a.reject("Не удалось загрузить изображение")}),a.promise()).done(function(){r.find("input, button, textarea").prop("disabled",!1),l.cropper("enable"),!1,n.find(".ladda-label").text("Загрузить"),n.ladda("stop"),r.modal("hide")}).fail(function(){alert("Загрузить изображене не удалось")})}),p.find(".select-image-from-device").on("click",function(){var e=t('<input type="file" style="display:none">');t("body").append(e),e.on("change",function(){var t=this.files[0];a(t)&&m(t).done(function(){g()}),e.remove()}),e.click()}),p.find(".select-image-from-url").on("click",function(){var t=prompt("Введите ссылку на изображение","http://");t&&f(t)}),p[0].ondragover=function(){return!1},p[0].ondragleave=function(){return!1},p[0].ondrop=function(t){var e=t.dataTransfer.files[0];a(e)&&m(e).done(function(){g()}),t.preventDefault()},o.val()>0&&t.post(e.urls.getImage,{id:o.val()},function(t){!0===t.success&&v(t)},"json")}}(jQuery);