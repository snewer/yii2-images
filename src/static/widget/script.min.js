!function(b){function y(a){return 0<a.size&&/^image/.test(a.type)}b.fn.ImageUploadWidget=function(t){var i,o=this.first(),a=!1,n=b('<div class="image-upload-widget-modal modal inmodal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content animated bounceInRight"><div class="modal-footer" style="border-top: none"><h5 class="pull-left">Загрузка изображения</h5><button type="button" class="image-upload-widget-modal-rotate-right-btn btn btn-primary"><span class="fa fa-rotate-right"></span></button><button type="button" class="image-upload-widget-modal-rotate-left-btn btn btn-primary"><span class="fa fa-rotate-left"></span></button></div><table style="width: 100%"><tbody><tr style="vertical-align: top"><td><div class="cropper-wrapper"><img src="#" style="display: none"></div></td></tr></tbody></table><div class="modal-footer" style="border-top: none"><button type="button" class="btn btn-white" data-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary ladda-button image-upload-widget-modal-upload-btn" data-style="expand-right">Загрузить выбранное</button></div></div></div></div>'),e=n.find(".image-upload-widget-modal-upload-btn").first(),d=n.find(".cropper-wrapper img").first(),l=n.find(".image-upload-widget-modal-rotate-left-btn"),s=n.find(".image-upload-widget-modal-rotate-right-btn"),r=b('<div class="image-upload-widget"><div class="uploaded-image-container-wrapper"><div class="uploaded-image-container"><div class="uploaded-image-preview"><img src="'+t.emptyImage+'"></div><div class="uploaded-image-toolbar"><span style="visibility: hidden" title="Обрезать изображение" class="edit fa fa-crop"></span><span  style="visibility: hidden" title="Удалить изображение" class="remove fa fa-times"></span><div class="clearfix"></div></div></div></div><div class="image-upload-tools"><span class="image-upload-tools-clickable select-image-from-device">Выбрать файл с компьютера</span> <span class="image-upload-tools-clickable select-image-from-url">или по URL</span></div></div>'),c=r.find(".uploaded-image-container-wrapper");function p(){n.modal("hide")}function u(){n.find("input, button, textarea").prop("disabled",!1),d.cropper("enable"),!1}function m(a){var e=b.Deferred(),t=new FileReader;return t.onload=function(a){i={src:a.target.result},e.resolve()},t.readAsDataURL(a),e.promise()}function f(a){return b.post(t.urls.imageProxy,{url:a},function(a){a.success&&(i={src:a.base64},g())},"json")}function g(){n.modal("show"),a?d.cropper("replace",i.src):(d.attr("src",i.src),d.cropper({autoCropArea:1,aspectRatio:0<t.aspectRatio?t.aspectRatio:NaN,checkCrossOrigin:!1,guides:!1,checkOrientation:!1,crop:function(){i.crop=b(this).cropper("getData",!0)}}),a=!0)}function v(a){var e=b('<div class="uploaded-image-container"><div class="uploaded-image-preview"><a href="'+a.image.url+'" target="_blank" style="display: block"><img src="'+a.preview.url+'"></a></div><div class="uploaded-image-toolbar"><span title="Обрезать изображение" class="edit fa fa-crop"></span><span title="Удалить изображение" class="remove fa fa-times"></span><div class="clearfix"></div></div></div>');c.html(e),e.find("a").magnificPopup({type:"image",closeOnContentClick:!0,mainClass:"mfp-img-mobile",image:{verticalFit:!0}}),e.find(".remove").on("click",function(){if(confirm("Удалить?")){o.val("");var a='<div class="uploaded-image-container-wrapper"><div class="uploaded-image-container"><div class="uploaded-image-preview"><img src="'+t.emptyImage+'"></div></div></div>';c.html(a)}}),e.find(".edit").on("click",function(){f(a.image.url)})}o.after(r),o.after(n),s.on("click",function(){d.cropper("rotate",45)}),l.on("click",function(){d.cropper("rotate",-45)}),e.ladda(),n.modal({backdrop:"static",keyboard:!1,show:!1}),e.on("click",function(){var e,a=b(this);n.find("input, button, textarea").prop("disabled",!0),d.cropper("disable"),!0,a.ladda("start"),a.find(".ladda-label").text("Идет загрузка..."),(e=b.Deferred(),b.post(t.urls.imageUpload,{source:i.src,options:{aspectRatio:t.aspectRatio,supportAC:t.supportAC,bgColor:t.bgColor,crop:i.crop||{}}}).done(function(a){!(i.src="")===a.success?(v(a),o.val(a.image.id),e.resolve(a)):e.reject()}),e.promise()).done(function(){u(),a.find(".ladda-label").text("Загрузить"),a.ladda("stop"),p()}).fail(function(){alert("Загрузить изображение не удалось"),u(),a.find(".ladda-label").text("Загрузить"),a.ladda("stop"),p()})}),r.find(".select-image-from-device").on("click",function(){var e=b('<input type="file" style="display:none">');b("body").append(e),e.on("change",function(){var a=this.files[0];y(a)&&m(a).done(function(){g()}),e.remove()}),e.click()}),r.find(".select-image-from-url").on("click",function(){var a=prompt("Введите ссылку на изображение","http://");a&&f(a)}),r[0].ondragover=function(){return!1},r[0].ondragleave=function(){return!1},r[0].ondrop=function(a){var e=a.dataTransfer.files[0];y(e)&&m(e).done(function(){g()}),a.preventDefault()},0<o.val()&&b.post(t.urls.getImage,{id:o.val()},function(a){!0===a.success&&v(a)},"json")}}(jQuery);